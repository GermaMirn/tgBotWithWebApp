# Настройка админских ролей

## Обзор

Система поддерживает назначение админских ролей через конфигурацию. Админы могут:
- Создавать ссылки для переключения ролей
- Просматривать все активные ссылки
- Управлять пользователями системы

## Настройка

### 1. Указание админских telegram_id

В файле `docker-compose.yml` найдите секцию `auth-service` и установите переменную `ADMIN_TELEGRAM_IDS`:

```yaml
environment:
  - ADMIN_TELEGRAM_IDS=123456789,987654321,555666777
```

Где `123456789,987654321,555666777` - это telegram_id пользователей, которые должны стать админами.

### 2. Получение telegram_id

Чтобы узнать свой telegram_id:
1. Зайдите в Telegram
2. Найдите бота @userinfobot
3. Отправьте ему любое сообщение
4. Бот вернет ваш telegram_id

### 3. Обновление ролей существующих пользователей

Если у вас уже есть пользователи в базе данных, запустите скрипт обновления:

```bash
# В контейнере auth-service
docker-compose exec auth-service python update_admin_roles.py

# Или локально (если настроена среда)
cd auth-service
python update_admin_roles.py
```

### 4. Перезапуск сервисов

После изменения конфигурации перезапустите auth-service:

```bash
docker-compose restart auth-service
```

## Проверка работы

### 1. Вход в систему
- Войдите в приложение через Telegram Mini App
- Если ваш telegram_id указан в `ADMIN_TELEGRAM_IDS`, вы автоматически получите роль админа

### 2. Проверка роли
- В сайдбаре должно отображаться "Администратор" вместо "Студент"
- Должен появиться пункт меню "Управление ролями"

### 3. Создание ссылок
- Перейдите в "Управление ролями"
- Создайте ссылку для роли "учитель"
- Скопируйте ссылку и отправьте пользователю

## Безопасность

- Админские telegram_id хранятся в переменных окружения
- Роль проверяется при каждом запросе к админским endpoint'ам
- JWT токен содержит информацию о роли пользователя
- Ссылки для переключения ролей имеют ограниченное время жизни

## Примеры конфигурации

### Один админ
```yaml
- ADMIN_TELEGRAM_IDS=123456789
```

### Несколько админов
```yaml
- ADMIN_TELEGRAM_IDS=123456789,987654321,555666777
```

### Без админов (только для тестирования)
```yaml
- ADMIN_TELEGRAM_IDS=
```

## Устранение неполадок

### Проблема: Пункт меню "Управление ролями" не появляется
**Решение:**
1. Проверьте, что ваш telegram_id указан в `ADMIN_TELEGRAM_IDS`
2. Перезапустите auth-service
3. Выйдите и войдите в приложение заново

### Проблема: Ошибка "Only admins can create role switch links"
**Решение:**
1. Убедитесь, что ваш telegram_id правильно указан в конфигурации
2. Проверьте, что в базе данных у вас роль "admin"
3. Запустите скрипт обновления ролей

### Проблема: Роль не обновляется автоматически
**Решение:**
1. Проверьте логи auth-service
2. Убедитесь, что переменная `ADMIN_TELEGRAM_IDS` правильно установлена
3. Запустите скрипт `update_admin_roles.py`